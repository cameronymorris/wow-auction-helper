<div class="panel panel-default">
	<div class="panel-heading">
		<h2 class="panel-title">Crafting</h2>
	</div>
	<div class="panel-body">
		<div class="row col-md-12">
			<!-- Action type selectors -->
			<div class="btn-group btn-group-xs col-md-12" role="group">
				<button type="button" class="btn btn-info" (click)="toggleDisenchanting(false)" [ngClass]="{'active': !isDisenchating}">
					Crafting
				</button>
				<button type="button" class="btn btn-info" (click)="toggleDisenchanting(true)" [ngClass]="{'active': isDisenchating}">
					Disenchanting
				</button>
			</div>
			
			<form class="form-inline col-md-12" (ngSubmit)="filteRecipes()" [formGroup]="filterForm">
				<!-- Regular crafting -->
				<span *ngIf="!isDisenchating; else disenchant">
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Search</span>
						<input class="col-md-2 form-control" type="text"
							placeholder="Item name" [formControl]="filterForm.controls['searchQuery']" aria-describedby="sizing-addon3"/>
					</div>

					<div class="input-group input-group-sm" *ngIf="myRecipes.length > 0">
						<span class="input-group-addon" id="sizing-addon3">Only known recipes</span>
						<span class="input-group-addon">
						<input type="checkbox" [formControl]="filterForm.controls['onlyMyRecipes']" aria-label="sizing-addon3">
						</span>
					</div>

					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min profit</span>
						<input name="profit" class="col-md-2 form-control" type="number"
							placeholder="Minimum profit (default 0)" [formControl]="filterForm.controls['profit']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">%</span>
					</div>


					<div *ngIf="apiToUse !== 'none'" class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min demand</span>
						<input class="col-md-2 form-control" type="number"
							placeholder="Minimum demand (default 0)" [formControl]="filterForm.controls['demand']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">%</span>
					</div>

					<div *ngIf="apiToUse !== 'none'" class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min sold</span>
						<input class="col-md-2 form-control" type="number"
							placeholder="Minimum sold (default 0)" [formControl]="filterForm.controls['minSold']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">pcs</span>
					</div>

					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Profession</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['profession']" aria-describedby="sizing-addon3">
							<option value="All">All</option>
							<option *ngFor="let i of professions" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Craft items</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['craftManually']" aria-describedby="sizing-addon3">
							<option *ngFor="let i of craftManually" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
				</span>
				<!-- Disenchatning crafting options -->
				<ng-template #disenchant>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="basic-addon1">Target item</span>
						<select class="form-control" aria-describedby="basic-addon1" [formControl]="filterForm.controls['selectedDEMaterial']">
							<option *ngFor="let item of Disenchanting.materials; let i = index"  [value]="i">
								{{ Disenchanting.getItemName(item.id) }}
							</option>
						</select>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Only profitable</span>
						<span class="input-group-addon">
							<input type="checkbox" aria-label="" [formControl]="filterForm.controls['DEOnlyProfitable']">
						</span>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Profession</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['profession']" aria-describedby="sizing-addon3">
							<option value="All">All</option>
							<option *ngFor="let i of professions" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
					<div class="input-group input-group-sm" *ngIf="myRecipes.length > 0">
						<span class="input-group-addon" id="sizing-addon3">Only known recipes</span>
						<span class="input-group-addon">
						<input type="checkbox" [formControl]="filterForm.controls['onlyMyRecipes']" aria-label="sizing-addon3">
						</span>
					</div>
				</ng-template>
				
				<button class="btn btn-primary" type="submit">Apply filter</button>
			</form>
		</div>
		<div class="col-md-12 row">
			<div class="pager">
				<button class="btn btn-default glyphicon glyphicon-arrow-left" (click)="changePage(-1)"></button>
				<input style="width:5em;" type="number" min="1" [(ngModel)]="currentPage" /> of {{ numOfPages }}
				<button class="btn btn-default glyphicon glyphicon-arrow-right" (click)="changePage(1)"></button>
			</div>
			<div class="col-md-9 row">
				<table *ngIf="!isDisenchating; else disenchantTable" class="table table-striped">
					<tr class="row">
						<th>Name</th>
						<th>Materials</th>
						<th class="hidden-xs" (click)="sortList('cost')">
							<i class="glyphicon glyphicon-sort" aria-hidden="true"></i>
							Cost
						</th>
						<th class="hidden-xs" (click)="sortList('buyout')">
							<i class="glyphicon glyphicon-sort" aria-hidden="true"></i>
							Buyout
						</th>
						<th data-toggle="tooltip" title="You can choose to sort by profit in % or in gold.">
							<span (click)="sortList('profit')">
								<i class="glyphicon glyphicon-sort" aria-hidden="true"></i>
								Profit
							</span>
							<select [(ngModel)]="sortProfitBy">
								<option value="g">Gold</option>
								<option value="%">Percent</option>
							</select>
							</th>
						<th *ngIf="apiToUse !== 'none'" class="hidden-xs">
							<span *ngIf="apiToUse === 'tsm'">Regional avg </span>
							<span *ngIf="apiToUse === 'wowuctions'">Avg posted/</span>
							sold
						</th>
						<th *ngIf="apiToUse !== 'none'" class="hidden-xs" (click)="sortList('estDemand')">
							<i class="glyphicon glyphicon-sort" aria-hidden="true"></i>
							<span *ngIf="apiToUse === 'tsm'">Region est Demand</span>
							<span *ngIf="apiToUse === 'wowuctions'">est demand/</span>
						</th>
						<th>
							Action
						</th>
					</tr>
					<!-- TODO: optimize price value fetch -->
					<tr class="row" *ngFor="let craft of crafts | slice:(currentPage - 1)*limit : ((currentPage - 1)*limit) + limit ;">
						<td>
							<div>
								<span xmlns="http://www.w3.org/1999/xhtml" class="icon-frame frame-36 align-left" [style.background-image]="'url('+ getIcon(craft.itemID) +')'"></span>
								<div class="align-left col-md-9">
									<a rel="item={{ craft.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{ craft.itemID }}"
										target="_blank">
										{{ craft.name }}</a>
									<br> {{ craft.profession }}
									({{ getAuctionItem(craft.itemID).quantity_total }} @ AH)
								</div>
							</div>
						</td>
						<td>
							<div class="clearfix"
								*ngFor="let m of craft.reagents"
								[ngClass]="{'not-found': !isAtAH(m.itemID)}">
								<span *ngIf="m.useCraftedBy === undefined || !m.useCraftedBy">
									{{ m.count }} x
									<a
										rel="item={{ m.itemID }}"
										href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{m.itemID}}"
											target="_blank">{{m.name}}</a>

									{{ copperToString(getMinPrice(m.itemID)) }} ({{ getAuctionItem(m.itemID).quantity_total }} @ AH)
									<i *ngIf="m.useCraftedBy !== undefined"
										class="glyphicon glyphicon-piggy-bank"
										[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
										(click)="setManualCraft(m, craft)"
										aria-hidden="true"></i>
								</span>

								<!-- For "child" recipes -->
								<div *ngIf="m.useCraftedBy !== undefined && m.useCraftedBy">
									<div class="clearfix"
										*ngFor="let subMats of getSubMaterials(m)"
										[ngClass]="{'not-found': !isAtAH(subMats.itemID)}">
										{{ subMats.count * m.count }} x
										<a rel="item={{ subMats.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{subMats.itemID}}"
												target="_blank">{{subMats.name}}</a>
										{{ copperToString(getMinPrice(subMats.itemID)) }} ({{ getAuction(subMats.itemID).quantity_total }} @ AH)
										<i *ngIf="m.useCraftedBy !== undefined"
											class="glyphicon glyphicon-piggy-bank"
											[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
											(click)="setManualCraft(m, craft)"
											aria-hidden="true"></i>
									</div>
								</div>
							</div>
						</td>
						<td class="hidden-xs">
							{{ copperToString(craft.cost) }}
						</td>
						<td class="hidden-xs">
							<span *ngIf="apiToUse === 'tsm' || apiToUse === 'wowuction'">
								Live:
							</span>
							{{ copperToString(craft.buyout) }}
							<span *ngIf="apiToUse === 'tsm' || apiToUse === 'wowuction'">
								({{ percentOf(craft.mktPrice, craft.buyout) }}% mkt)
								<br>Market value: {{
									copperToString(
										getApiItem(craft.itemID)
											.mktPrice)
									}}
								<br>Region sale avg: {{ 
									copperToString(
										getApiItem(craft.itemID)
												.regionSaleAvg) }}
							</span>
						</td>
						<td>
							{{ copperToString(craft.profit) }} <br> {{ getProfitPercent(craft.profit, craft.buyout) }} %
							<span class="visible-xs glyphicon glyphicon-shopping-cart" aria-hidden="true" (click)="addToCart(craft)"></span>
						</td>
						<td *ngIf="apiToUse !== 'none'"  class="hidden-xs">
							<span *ngIf="apiToUse === 'wowuctions'">
								{{ getApiItem(craft.itemID)
										.avgDailyPosted }} <br>
							</span>
							{{ getApiItem(craft.itemID)
									.avgDailySold }}
						</td>
						<td class="hidden-xs">
							<span *ngIf="apiToUse !== 'none'" >{{
									getApiItem(craft.itemID)
										.estDemand | percent }}
							</span>
						</td>
						<td>
							<a class="glyphicon glyphicon-shopping-cart"
								aria-hidden="true"
								(click)="addToCart(craft)">Add</a><br>
							<a class="glyphicon glyphicon-exclamation-sign"
								aria-hidden="true"
								href="http://www.wowhead.com/item={{craft.itemID}}"
								target="_blank">Wowhead</a><br>
						</td>
					</tr>
				</table>
				<ng-template #disenchantTable>
					<table class="table table-striped">
						<tr>
							<th>Item</th>
							<th>Materials</th>
							<th>Cost</th>
							<th>Profit</th>
							<th>Action</th>
						</tr>
						<tr *ngFor="let craft of Disenchanting.disenchantables | slice:(currentPage - 1)*limit : ((currentPage - 1)*limit) + limit ;">
							<td>
							<div>
								<span xmlns="http://www.w3.org/1999/xhtml" class="icon-frame frame-36 align-left" [style.background-image]="'url('+ getIcon(craft.itemID) +')'"></span>
								<div class="align-left col-md-9">
									<a rel="item={{ craft.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{ craft.itemID }}"
										target="_blank">
										{{ craft.name }}</a>
									<br> {{ craft.profession }}
									({{ getAuctionItem(craft.itemID).quantity_total }} @ AH)
								</div>
							</div>
						</td>
							<td>
								<div class="clearfix"
									*ngFor="let m of craft.reagents"
									[ngClass]="{'not-found': !isAtAH(m.itemID)}">
									<span *ngIf="m.useCraftedBy === undefined || !m.useCraftedBy">
										{{ m.count }} x
										<a
											rel="item={{ m.itemID }}"
											href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{m.itemID}}"
												target="_blank">{{m.name}}</a>

										{{ copperToString(getMinPrice(m.itemID)) }} ({{ getAuctionItem(m.itemID).quantity_total }} @ AH)
										<i *ngIf="m.useCraftedBy !== undefined"
											class="glyphicon glyphicon-piggy-bank"
											[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
											(click)="setManualCraft(m, craft)"
											aria-hidden="true"></i>
									</span>

									<!-- For "child" recipes -->
									<div *ngIf="m.useCraftedBy !== undefined && m.useCraftedBy">
										<div class="clearfix"
											*ngFor="let subMats of getSubMaterials(m)"
											[ngClass]="{'not-found': !isAtAH(subMats.itemID)}">
											{{ subMats.count * m.count }} x
											<a rel="item={{ subMats.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{subMats.itemID}}"
													target="_blank">{{subMats.name}}</a>
											{{ copperToString(getMinPrice(subMats.itemID)) }} ({{ getAuctionItem(subMats.itemID).quantity_total }} @ AH)
											<i *ngIf="m.useCraftedBy !== undefined"
												class="glyphicon glyphicon-piggy-bank"
												[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
												(click)="setManualCraft(m, craft)"
												aria-hidden="true"></i>
										</div>
									</div>
								</div>
							</td>
							<td>
								{{ copperToString(craft.cost) }}
							</td>
							<td>
								{{ copperToString( getMinPrice(Disenchanting.materials[Disenchanting.selected].id) - craft.cost ) }}
							</td>
							<td>
								<a class="glyphicon glyphicon-shopping-cart"
									aria-hidden="true"
									(click)="addToCart(craft)">Add</a><br>
								<a class="glyphicon glyphicon-exclamation-sign"
									aria-hidden="true"
									href="http://www.wowhead.com/item={{craft.itemID}}"
									target="_blank">Wowhead</a><br>
							</td>
						</tr>
					</table>
				</ng-template>
			</div>
			<div class="col-md-3">
				<div class="col-sm-6 col-md-12" *ngIf="isDisenchating">
					<div class="thumbnail row">
						<span>
							<span xmlns="http://www.w3.org/1999/xhtml" class="icon-frame frame-24" [style.background-image]="'url('+ getIcon(Disenchanting.materials[Disenchanting.selected].id) +')'"></span>
							<a rel="item={{ Disenchanting.materials[Disenchanting.selected].id }}" href="http://www.wowhead.com/item={{ Disenchanting.materials[Disenchanting.selected].id }}" target="_blank">
								{{ Disenchanting.getItemName(Disenchanting.materials[Disenchanting.selected].id) }}
							</a>
						</span>
						<div class="caption">
							Buyout: {{ copperToString(getMinPrice(Disenchanting.materials[Disenchanting.selected].id)) }} <br>
							<div *ngIf="user.apiTouse !== 'none'">
								Market value: {{ copperToString(getAuctionItem(Disenchanting.materials[Disenchanting.selected].id).mktPrice) }} <br>
								Region sale avg: {{
									copperToString(
										getApiItem(
											Disenchanting
												.materials[Disenchanting.selected].id)
													.regionSaleAvg)
								}} <br> Est demand: {{
									getApiItem(
										Disenchanting.materials[Disenchanting.selected].id)
											.estDemand | percent}} <br>
							</div>
						</div>
					</div>
				</div>
				<strong>Shopping cart</strong>
				<ul>
					<li *ngFor="let a of shoppingCart.recipes">
						<a rel="item={{ a.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{ a.itemID }}"
										target="_blank">{{ a.name }}</a> x
										{{ (a.quantity / a.minCount).toFixed(2) }}
										<span *ngIf="a.minCount != 1">({{ a.quantity }} pcs)</span> <i  class="glyphicon glyphicon-remove" aria-hidden="true" (click)="removeFromCart(a.spellID)"></i>
					</li>
				</ul>
				<strong>Reagents</strong>
				<ul>
					<li *ngFor="let a of shoppingCart.reagents">
						<a rel="item={{ a.itemID }}"
							href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{ a.itemID }}"
							target="_blank">
							{{ a.name }} x {{ a.count }} for {{ copperToString( getMinPrice(a.itemID) * a.count) }}
							<i  class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></i>
						</a>
					</li>
				</ul>
				Sum buyout from AH: {{ copperToString(shoppingCart.buyout) }} <br>
				Sum material cost from AH: {{ copperToString(shoppingCart.cost) }} <br>
				Potential sale profit: {{ copperToString(shoppingCart.profit) }}<br>
				<a class="btn btn-default" (click)="clearCart()">Empty shopping cart</a>
			</div>
		</div>
		<div class="pager">
			<button class="btn btn-default glyphicon glyphicon-arrow-left" (click)="changePage(-1)"></button>
			<input style="width:5em;" type="number" min="1" [(ngModel)]="currentPage" /> of {{ numOfPages }}
			<button class="btn btn-default glyphicon glyphicon-arrow-right" (click)="changePage(1)"></button>
		</div>
		<em>
			If there are any recipes missing, please notify me @ 
			<a href="https://www.reddit.com/r/woweconomy/comments/61m0jj/professioncrafting_auctioning_toolwebapp/">reddit</a> 
			by giving me the itemID (item=12345 after wowhead link) of the target item and the spellID (spell=12345 in the wowhead link)for the recipe.
			If you do this, Il'l add them asap.
		</em>
	</div>
</div>
