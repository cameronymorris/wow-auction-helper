<div class="panel panel-default">
	<div class="panel-heading">
		<h2 class="panel-title">Crafting</h2>
	</div>
	<div class="panel-body">
		<div class="row col-md-12">
			<!-- Action type selectors -->
			<div class="btn-group btn-group-xs col-md-12" role="group">
				<button type="button" class="btn btn-info" (click)="toggleDisenchanting(false)" [ngClass]="{'active': !isDisenchating}">
					Crafting
				</button>
				<button type="button" class="btn btn-info" (click)="toggleDisenchanting(true)" [ngClass]="{'active': isDisenchating}">
					Disenchanting
				</button>
			</div>
			
			<form class="form-inline col-md-12" (ngSubmit)="filteRecipes()" [formGroup]="filterForm">
				<!-- Regular crafting -->
				<span *ngIf="!isDisenchating; else disenchant">
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Search</span>
						<input class="col-md-2 form-control" type="text"
							placeholder="Item name" [formControl]="filterForm.controls['searchQuery']" aria-describedby="sizing-addon3"/>
					</div>

					<div class="input-group input-group-sm" *ngIf="myRecipes.length > 0">
						<span class="input-group-addon" id="sizing-addon3">Only known recipes</span>
						<span class="input-group-addon">
						<input type="checkbox" [formControl]="filterForm.controls['onlyMyRecipes']" aria-label="sizing-addon3">
						</span>
					</div>

					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min profit</span>
						<input name="profit" class="col-md-2 form-control" type="number"
							placeholder="Minimum profit (default 0)" [formControl]="filterForm.controls['profit']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">%</span>
					</div>


					<div *ngIf="apiToUse !== 'none'" class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min demand</span>
						<input class="col-md-2 form-control" type="number"
							placeholder="Minimum demand (default 0)" [formControl]="filterForm.controls['demand']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">%</span>
					</div>

					<div *ngIf="apiToUse !== 'none'" class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Min sold</span>
						<input class="col-md-2 form-control" type="number"
							placeholder="Minimum sold (default 0)" [formControl]="filterForm.controls['minSold']" aria-describedby="sizing-addon3"/>
						<span class="input-group-addon" id="sizing-addon3">pcs</span>
					</div>

					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Profession</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['profession']" aria-describedby="sizing-addon3">
							<option value="All">All</option>
							<option *ngFor="let i of professions" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Craft items</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['craftManually']" aria-describedby="sizing-addon3">
							<option *ngFor="let i of craftManually" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
				</span>
				<!-- Disenchatning crafting options -->
				<ng-template #disenchant>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="basic-addon1">Target item</span>
						<select class="form-control" aria-describedby="basic-addon1" [formControl]="filterForm.controls['selectedDEMaterial']">
							<option *ngFor="let item of Disenchanting.materials; let i = index"  [value]="i">
								{{ Disenchanting.getItemName(item.id) }}
							</option>
						</select>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Only profitable</span>
						<span class="input-group-addon">
							<input type="checkbox" aria-label="" [formControl]="filterForm.controls['DEOnlyProfitable']">
						</span>
					</div>
					<div class="input-group input-group-sm">
						<span class="input-group-addon" id="sizing-addon3">Profession</span>
						<select name="profession" class="form-control" [formControl]="filterForm.controls['profession']" aria-describedby="sizing-addon3">
							<option value="All">All</option>
							<option *ngFor="let i of professions" value="{{ i }}">{{ i }}</option>
						</select>
					</div>
					<div class="input-group input-group-sm" *ngIf="myRecipes.length > 0">
						<span class="input-group-addon" id="sizing-addon3">Only known recipes</span>
						<span class="input-group-addon">
						<input type="checkbox" [formControl]="filterForm.controls['onlyMyRecipes']" aria-label="sizing-addon3">
						</span>
					</div>
				</ng-template>
				
				<button class="btn btn-primary" type="submit">Apply filter</button>
			</form>
		</div>
		<div class="col-md-12 row">
			<md-paginator class="col-md-9 row"
				[length]="isDisenchating ? Disenchanting?.disenchantables?.length : crafts?.length"
				[pageSize]="page.pageSize"
				[pageSizeOptions]="page.pageSizeOptions"
				[pageIndex]="pageEvent.pageIndex"
				(page)="changePage($event)">
			</md-paginator>
			<div class="col-md-9 row">
				<app-craft-table *ngIf="!isDisenchating; else disenchantTable"
					[pageEvent]="pageEvent"
					[user]="user"
					[crafts]="crafts"
					[atAH]="isAtAh"
					[getIcon]="getIcon"
					[getName]="getName"
					[getProfitPercent]="getProfitPercent"
					[getMinPrice]="getMinPrice"
					[getAuctionItem]="getAuctionItem"
					[sortList]="sortList"
					[openMenu]="openMenu"
					(addToCart)="addToCart($event)"
					[getApiItem]="getApiItem">
				</app-craft-table>
				<ng-template #disenchantTable>
					<table class="table table-striped">
						<tr>
							<th>Item</th>
							<th>Materials</th>
							<th>Cost</th>
							<th>Profit</th>
							<th>Action</th>
						</tr>
						<tr *ngFor="
							let craft of Disenchanting?.disenchantables |
								slice: 
									(pageEvent.pageSize * (pageEvent.pageIndex + 1)) - pageEvent.pageSize:
									pageEvent.pageSize * (pageEvent.pageIndex + 1) ;
							let i = index;">
							<td>
								<div>
									<span xmlns="http://www.w3.org/1999/xhtml" class="icon-frame frame-36 align-left" [style.background-image]="'url('+ getIcon(craft.itemID) +')'"></span>
									<div class="align-left col-md-9">
										<a rel="item={{ craft.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{ craft.itemID }}"
											target="_blank">
											{{ craft.name }}</a>
										<br> {{ craft.profession }}
										({{ getAuctionItem(craft.itemID).quantity_total }} @ AH)
									</div>
								</div>
							</td>
							<td>
								<div class="clearfix"
									*ngFor="let m of craft.reagents"
									[ngClass]="{'not-found': !isAtAH(m.itemID)}">
									<span *ngIf="m.useCraftedBy === undefined || !m.useCraftedBy">
										{{ m.count }} x
										<a
											rel="item={{ m.itemID }}"
											href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{m.itemID}}"
												target="_blank">{{m.name}}</a>

										{{ getMinPrice(m.itemID) | gold }} ({{ getAuctionItem(m.itemID).quantity_total }} @ AH)
										<i *ngIf="m.useCraftedBy !== undefined"
											class="glyphicon glyphicon-piggy-bank"
											[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
											(click)="setManualCraft(m, craft)"
											aria-hidden="true"></i>
									</span>

									<!-- For "child" recipes -->
									<div *ngIf="m.useCraftedBy !== undefined && m.useCraftedBy">
										<div class="clearfix"
											*ngFor="let subMats of getSubMaterials(m)"
											[ngClass]="{'not-found': !isAtAH(subMats.itemID)}">
											{{ subMats.count * m.count }} x
											<a rel="item={{ subMats.itemID }}" href="https://{{ user.region }}.battle.net/wow/en/vault/character/auction/browse?reverse=false&sort=unitBuyout&itemId={{subMats.itemID}}"
													target="_blank">{{subMats.name}}</a>
											{{ getMinPrice(subMats.itemID) | gold }} ({{ getAuctionItem(subMats.itemID).quantity_total }} @ AH)
											<i *ngIf="m.useCraftedBy !== undefined"
												class="glyphicon glyphicon-piggy-bank"
												[ngClass]="{'using-manual-craft': m.useCraftedBy, 'not-using-manual-craft': !m.useCraftedBy}"
												(click)="setManualCraft(m, craft)"
												aria-hidden="true"></i>
										</div>
									</div>
								</div>
							</td>
							<td>
								{{ craft.cost | gold }}
							</td>
							<td>
								{{ getMinPrice(Disenchanting.materials[Disenchanting.selected].id) - craft.cost | gold }}
							</td>
							<td>
								<a class="glyphicon glyphicon-shopping-cart push-left"
									aria-hidden="true"
									(click)="openMenu(i)">Add</a><br>
								<div class="recipe-menu recipe-menu-dark"
									[ngClass]="{'recipe-menu-open': i === selectedItemIndex}">
									<div class="panel-body">
										Add quantity:<br>
										<input type="number" value="1" min="1" #quantityToAdd/><br>
										<a class="push-left"
											aria-hidden="true"
											(click)="addToCart(craft, quantityToAdd.value)">
											<i class="glyphicon glyphicon-shopping-cart"></i>
											Add amount
										</a>
									</div>
								</div>
								<a class="glyphicon glyphicon-exclamation-sign"
									aria-hidden="true"
									href="http://www.wowhead.com/item={{craft.itemID}}"
									target="_blank">Wowhead</a><br>
							</td>
						</tr>
					</table>
				</ng-template>
			</div>
			<div class="col-md-3">
				<div class="col-sm-6 col-md-12" *ngIf="isDisenchating">
					<div class="thumbnail row">
						<span>
							<span xmlns="http://www.w3.org/1999/xhtml" class="icon-frame frame-24" [style.background-image]="'url('+ getIcon(Disenchanting.materials[Disenchanting.selected].id) +')'"></span>
							<a rel="item={{ Disenchanting.materials[Disenchanting.selected].id }}" href="http://www.wowhead.com/item={{ Disenchanting.materials[Disenchanting.selected].id }}" target="_blank">
								{{ Disenchanting.getItemName(Disenchanting.materials[Disenchanting.selected].id) }}
							</a>
						</span>
						<div class="caption">
							Buyout: {{ getMinPrice(Disenchanting.materials[Disenchanting.selected].id) | gold }} <br>
							<div *ngIf="user.apiTouse !== 'none'">
								Market value: {{ getAuctionItem(Disenchanting.materials[Disenchanting.selected].id).mktPrice | gold }} <br>
								Region sale avg: {{
									getApiItem(
										Disenchanting
											.materials[Disenchanting.selected].id)
												.regionSaleAvg | gold
								}} <br> Est demand: {{
									getApiItem(
										Disenchanting.materials[Disenchanting.selected].id)
											.estDemand | percent}} <br>
							</div>
						</div>
					</div>
				</div>
				<app-shopping-cart
					[shoppingCart]="shoppingCart"
					[user]="user"
					[getMinPrice]="getMinPrice"
					(removeFromCart)="removeFromCart($event)"
					(clearCart)="clearCart()">
				</app-shopping-cart>
			</div>
		</div>
		<md-paginator class="col-md-9 row"
			[length]="isDisenchating ? Disenchanting?.disenchantables?.length : crafts?.length"
			[pageSize]="page.pageSize"
			[pageSizeOptions]="page.pageSizeOptions"
			[pageIndex]="pageEvent.pageIndex"
			(page)="changePage($event)">
		</md-paginator>
		<em class="col-md-9">
			If there are any recipes missing, please notify me @ 
			<a href="https://www.reddit.com/r/woweconomy/comments/61m0jj/professioncrafting_auctioning_toolwebapp/">reddit</a> 
			by giving me the itemID (item=12345 after wowhead link) of the target item and the spellID (spell=12345 in the wowhead link)for the recipe.
			If you do this, Il'l add them asap.
		</em>
	</div>
</div>
